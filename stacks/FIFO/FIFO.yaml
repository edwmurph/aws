Description: Provisions an SQS FIFO queue with a Lambda that processes items one at a time

Resources:
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole

  Queue:
    Type: AWS::SQS::Queue
    Properties:
      FifoQueue: true
      VisibilityTimeout: 30
      ContentBasedDeduplication: true

  Lambda:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.handler
      Runtime: nodejs16.x
      Role: !GetAtt LambdaRole.Arn
      ReservedConcurrentExecutions: 1
      Timeout: 30
      Code:
        ZipFile: |
          exports.handler = async function(event) {
            const wait = ( ms ) => new Promise( r => setTimeout( r, ms ) );
            const events = event.Records.map( record => record.body );
            console.log('start', events);
            await wait(10e3);
            console.log('stop', events);
            return {
              statusCode: 200,
              body: JSON.stringify('Hello from Lambda!'),
            };
          };

  EventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 1
      EventSourceArn: !GetAtt Queue.Arn
      FunctionName: !GetAtt Lambda.Arn
      # ScalingConfig:
      #   MaximumConcurrency: 2

Outputs:
  TestFIFOEndpoint:
    Description: Queue URL
    Value: !GetAtt Queue.QueueUrl
